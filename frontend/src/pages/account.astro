---
import Layout from '../layouts/Layout.astro';
import { fetchMe, listChildren } from '../lib/api';

export const prerender = false;

// Check if user is logged in
const cookieHeader = Astro.request.headers.get('cookie') ?? undefined;
let user = null;
let children: Array<{ id: string; name: string; dateOfBirth?: string | null }> = [];

try {
	user = await fetchMe(cookieHeader);
	if (user) {
		children = await listChildren(cookieHeader);
	}
} catch (e) {
	// Not logged in, redirect to login
	return Astro.redirect('/auth/login?returnTo=/account');
}

if (!user) {
	return Astro.redirect('/auth/login?returnTo=/account');
}

const signupSuccess = Astro.url.searchParams.get('signup') === 'success';
const profileIncomplete = !user.name || !user.phone;
---

<Layout>
	<main class="bg-gray-50 py-12 md:py-16">
		<div class="container-custom">
			<div class="mx-auto max-w-4xl">
				{
					profileIncomplete && (
						<div
							id="first-login-modal"
							class="fixed inset-0 z-50 flex items-center justify-center bg-black/50"
						>
							<div class="mx-4 w-full max-w-md rounded-2xl bg-white p-6 shadow-xl">
								<h2 class="text-2xl font-bold text-gray-900">Welcome!</h2>
								<p class="mt-2 text-gray-600">Please complete your profile to get started.</p>
								<form id="first-login-form" class="mt-6 space-y-4">
									<div>
										<label for="first-name" class="block text-sm font-semibold text-gray-700">
											Full Name *
										</label>
										<input
											type="text"
											id="first-name"
											name="name"
											value={user.name || ''}
											required
											placeholder="John Doe"
											class="mt-2 w-full rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-gray-900 focus:border-tuhura-green focus:ring-2 focus:ring-tuhura-green/20 focus:outline-none"
										/>
									</div>

									<div>
										<label for="first-phone" class="block text-sm font-semibold text-gray-700">
											Phone Number *
										</label>
										<input
											type="tel"
											id="first-phone"
											name="phone"
											value={user.phone || ''}
											required
											placeholder="+64 21 123 4567"
											class="mt-2 w-full rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-gray-900 focus:border-tuhura-green focus:ring-2 focus:ring-tuhura-green/20 focus:outline-none"
										/>
									</div>

									<div>
										{' '}
										<label for="first-referral" class="block text-sm font-semibold text-gray-700">
											How did you hear about us?
										</label>
										<input
											type="text"
											id="first-referral"
											name="referralSource"
											placeholder="School newsletter, friend, social media..."
											class="mt-2 w-full rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-gray-900 focus:border-tuhura-green focus:ring-2 focus:ring-tuhura-green/20 focus:outline-none"
										/>
									</div>

									<div>
										{' '}
										<label class="flex items-center gap-3">
											<input
												type="checkbox"
												id="first-newsletter"
												name="newsletter"
												class="h-4 w-4 rounded border-gray-300 text-tuhura-green focus:ring-tuhura-green"
											/>
											<span class="text-sm text-gray-700">
												Subscribe to our newsletter for updates and events
											</span>
										</label>
									</div>

									<button type="submit" class="btn btn-primary w-full">
										Complete Setup
									</button>
									<p id="first-login-message" class="hidden text-sm" />
								</form>
							</div>
						</div>
					)
				}

				<div class="flex items-center justify-between">
					<h1 class="text-3xl font-bold text-gray-900">My Account</h1>
					<button id="logout-btn" class="btn btn-secondary btn-sm"> Sign out </button>
				</div>

				{
					signupSuccess && (
						<div class="mt-6 rounded-lg border border-emerald-200 bg-emerald-50 p-4">
							<p class="font-semibold text-emerald-800">✓ Signup successful!</p>
							<p class="mt-1 text-sm text-emerald-700">
								Your child has been registered for the session. You'll receive a confirmation email
								shortly.
							</p>
						</div>
					)
				}

				<!-- Profile Section -->
				<div class="mt-8 rounded-2xl border border-gray-200 bg-white p-6 shadow-sm">
					<h2 class="text-xl font-semibold text-gray-900">Profile</h2>
					<form id="profile-form" class="mt-4 space-y-4">
						<div>
							<label for="email" class="block text-sm font-semibold text-gray-700">Email</label>
							<input
								type="email"
								id="email"
								value={user.email}
								disabled
								class="mt-2 w-full rounded-lg border border-gray-300 bg-gray-100 px-4 py-2.5 text-gray-600"
							/>
							<p class="mt-1 text-xs text-gray-500">Your email cannot be changed</p>
						</div>

						<div>
							<label for="name" class="block text-sm font-semibold text-gray-700">Name</label>
							<input
								type="text"
								id="name"
								name="name"
								value={user.name || ''}
								class="mt-2 w-full rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-gray-900 focus:border-tuhura-green focus:ring-2 focus:ring-tuhura-green/20 focus:outline-none"
							/>
						</div>

						<div>
							<label for="phone" class="block text-sm font-semibold text-gray-700">Phone</label>
							<input
								type="tel"
								id="phone"
								name="phone"
								value={user.phone || ''}
								class="mt-2 w-full rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-gray-900 focus:border-tuhura-green focus:ring-2 focus:ring-tuhura-green/20 focus:outline-none"
							/>
						</div>

						<button type="submit" class="btn btn-primary"> Save profile </button>
						<p id="profile-message" class="hidden text-sm"></p>
					</form>
				</div>

				<!-- Children Section -->
				<div class="mt-8 rounded-2xl border border-gray-200 bg-white p-6 shadow-sm">
					<div class="flex items-center justify-between">
						<h2 class="text-xl font-semibold text-gray-900">My Children</h2>
						<button id="add-child-btn" class="btn btn-primary btn-sm"> Add child </button>
					</div>

					<div id="children-list" class="mt-6 space-y-4">
						{
							children.length === 0 ? (
								<p class="text-gray-600">
									No children added yet. Click "Add child" to get started.
								</p>
							) : (
								children.map((child) => (
									<div class="rounded-lg border border-gray-200 p-4">
										<div class="flex items-start justify-between">
											<div>
												<p class="font-semibold text-gray-900">{child.name}</p>
												{child.dateOfBirth && (
													<p class="text-sm text-gray-600">
														Born: {new Date(child.dateOfBirth).toLocaleDateString('en-NZ')}
													</p>
												)}
											</div>
											<button
												class="text-sm text-tuhura-green hover:text-tuhura-green/80"
												data-child-id={child.id}
											>
												Edit
											</button>
										</div>
									</div>
								))
							)
						}
					</div>
				</div>

				<!-- Add Child Modal -->
				<div
					id="add-child-modal"
					class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 p-4"
				>
					<div
						class="my-auto max-h-[85vh] w-full max-w-2xl overflow-y-auto rounded-2xl bg-white shadow-xl"
					>
						<div class="sticky top-0 rounded-t-2xl border-b border-gray-200 bg-white px-6 py-4">
							<h3 class="text-xl font-semibold text-gray-900">Add a child</h3>
						</div>
						<form id="add-child-form" class="space-y-4 p-6">
							<div>
								<label for="child-name" class="block text-sm font-semibold text-gray-700"
									>Name <span class="text-red-600">*</span></label
								>
								<input
									type="text"
									id="child-name"
									name="name"
									required
									class="mt-2 w-full rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-gray-900 focus:border-tuhura-green focus:ring-2 focus:ring-tuhura-green/20 focus:outline-none"
								/>
							</div>

							<div>
								<label for="child-dob" class="block text-sm font-semibold text-gray-700"
									>Date of Birth <span class="text-red-600">*</span></label
								>
								<input
									type="date"
									id="child-dob"
									name="dateOfBirth"
									required
									class="mt-2 w-full rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-gray-900 focus:border-tuhura-green focus:ring-2 focus:ring-tuhura-green/20 focus:outline-none"
								/>
							</div>

							<div class="flex items-center gap-3">
								<input
									type="checkbox"
									id="child-media-consent"
									name="mediaConsent"
									class="h-4 w-4 rounded border-gray-300 text-tuhura-green focus:ring-tuhura-green"
								/>
								<label for="child-media-consent" class="text-sm text-gray-700">
									I consent to photos/videos of my child being used for promotional purposes
								</label>
							</div>

							<div>
								<label for="child-medical" class="block text-sm font-semibold text-gray-700"
									>Medical Information</label
								>
								<textarea
									id="child-medical"
									name="medicalInfo"
									rows="2"
									placeholder="Allergies, medications, or other medical information..."
									class="mt-2 w-full rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-gray-900 focus:border-tuhura-green focus:ring-2 focus:ring-tuhura-green/20 focus:outline-none"
								></textarea>
							</div>

							<div>
								<label for="child-other" class="block text-sm font-semibold text-gray-700"
									>Other Information</label
								>
								<textarea
									id="child-other"
									name="otherInfo"
									rows="2"
									placeholder="Any other information we should know..."
									class="mt-2 w-full rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-gray-900 focus:border-tuhura-green focus:ring-2 focus:ring-tuhura-green/20 focus:outline-none"
								></textarea>
							</div>
							<!-- Demographic Information (Optional - for reporting) -->
							<div class="rounded-lg border border-gray-200 bg-gray-50 p-4">
								<p class="mb-3 text-xs text-gray-600">
									<strong>Optional:</strong> The following information is used for reporting purposes
									only and helps us understand who we serve.
								</p>

								<div class="space-y-3">
									<div>
										<label for="child-region" class="block text-sm font-semibold text-gray-700"
											>Region</label
										>
										<input
											type="text"
											id="child-region"
											name="region"
											placeholder="e.g., Wellington, Auckland"
											class="mt-1 w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 focus:border-tuhura-green focus:ring-2 focus:ring-tuhura-green/20 focus:outline-none"
										/>
									</div>

									<div>
										<label for="child-ethnicity" class="block text-sm font-semibold text-gray-700"
											>Ethnicity</label
										>
										<input
											type="text"
											id="child-ethnicity"
											name="ethnicity"
											placeholder="e.g., NZ European, Māori, Pacific Islander"
											class="mt-1 w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 focus:border-tuhura-green focus:ring-2 focus:ring-tuhura-green/20 focus:outline-none"
										/>
									</div>

									<div>
										<label for="child-gender" class="block text-sm font-semibold text-gray-700"
											>Gender</label
										>
										<input
											type="text"
											id="child-gender"
											name="gender"
											placeholder="e.g., Male, Female"
											class="mt-1 w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 focus:border-tuhura-green focus:ring-2 focus:ring-tuhura-green/20 focus:outline-none"
										/>
									</div>

									<div>
										<label for="child-school" class="block text-sm font-semibold text-gray-700"
											>School Name</label
										>
										<input
											type="text"
											id="child-school"
											name="schoolName"
											placeholder="e.g., Wellington Primary School"
											class="mt-1 w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 focus:border-tuhura-green focus:ring-2 focus:ring-tuhura-green/20 focus:outline-none"
										/>
									</div>
								</div>
							</div>
							<div class="flex gap-3">
								<button type="submit" class="btn btn-primary flex-1"> Add child </button>
								<button type="button" id="cancel-add-child" class="btn btn-secondary flex-1">
									Cancel
								</button>
							</div>
							<p id="add-child-message" class="hidden text-sm"></p>
						</form>
					</div>
				</div>
			</div>
		</div>
	</main>
</Layout>

<script>
	import { updateMe, logout, createChild } from '../lib/api';

	// Profile form
	const profileForm = document.getElementById('profile-form') as HTMLFormElement;
	const profileMessage = document.getElementById('profile-message');

	profileForm?.addEventListener('submit', async (e) => {
		e.preventDefault();
		const formData = new FormData(profileForm);
		const name = formData.get('name') as string;
		const phone = formData.get('phone') as string;

		try {
			await updateMe({ name, phone });
			if (profileMessage) {
				profileMessage.textContent = 'Profile updated successfully!';
				profileMessage.className = 'text-sm text-emerald-600';
				profileMessage.classList.remove('hidden');
			}
		} catch (error) {
			if (profileMessage) {
				profileMessage.textContent = 'Failed to update profile';
				profileMessage.className = 'text-sm text-red-600';
				profileMessage.classList.remove('hidden');
			}
		}
	});

	// Logout
	const logoutBtn = document.getElementById('logout-btn');
	logoutBtn?.addEventListener('click', async () => {
		try {
			await logout();
			window.location.href = '/';
		} catch (error) {
			console.error('Logout failed:', error);
		}
	});

	// Add child modal
	const addChildBtn = document.getElementById('add-child-btn');
	const addChildModal = document.getElementById('add-child-modal');
	const cancelAddChild = document.getElementById('cancel-add-child');
	const addChildForm = document.getElementById('add-child-form') as HTMLFormElement;
	const addChildMessage = document.getElementById('add-child-message');

	addChildBtn?.addEventListener('click', () => {
		addChildModal?.classList.remove('hidden');
	});

	cancelAddChild?.addEventListener('click', () => {
		addChildModal?.classList.add('hidden');
		addChildForm?.reset();
	});

	addChildForm?.addEventListener('submit', async (e) => {
		e.preventDefault();
		const formData = new FormData(addChildForm);
		const name = formData.get('name') as string;
		const dateOfBirth = formData.get('dateOfBirth') as string;
		const mediaConsent = formData.get('mediaConsent') === 'on';
		const medicalInfo = (formData.get('medicalInfo') as string) || undefined;
		const otherInfo = (formData.get('otherInfo') as string) || undefined;
		const region = (formData.get('region') as string) || undefined;
		const ethnicity = (formData.get('ethnicity') as string) || undefined;
		const gender = (formData.get('gender') as string) || undefined;
		const schoolName = (formData.get('schoolName') as string) || undefined;

		try {
			await createChild({
				name,
				dateOfBirth,
				...(mediaConsent && { mediaConsent }),
				...(medicalInfo && { medicalInfo }),
				...(otherInfo && { otherInfo }),
				...(region && { region }),
				...(ethnicity && { ethnicity }),
				...(gender && { gender }),
				...(schoolName && { schoolName }),
			});
			if (addChildMessage) {
				addChildMessage.textContent = 'Child added successfully!';
				addChildMessage.className = 'text-sm text-emerald-600';
				addChildMessage.classList.remove('hidden');
			}
			// Reload page to show new child
			setTimeout(() => window.location.reload(), 1000);
		} catch (error) {
			if (addChildMessage) {
				addChildMessage.textContent = 'Failed to add child';
				addChildMessage.className = 'text-sm text-red-600';
				addChildMessage.classList.remove('hidden');
			}
		}
	});

	// First-login form
	const firstLoginForm = document.getElementById('first-login-form') as HTMLFormElement;
	const firstLoginMessage = document.getElementById('first-login-message');

	firstLoginForm?.addEventListener('submit', async (e) => {
		e.preventDefault();
		const formData = new FormData(firstLoginForm);
		const name = formData.get('name') as string;
		const phone = formData.get('phone') as string;
		const newsletter = formData.get('newsletter') === 'on';
		const referralSource = (formData.get('referralSource') as string) || undefined;

		try {
			// Update profile
			await updateMe({
				name,
				phone,
				...(newsletter && { newsletter }),
				...(referralSource && { referralSource }),
			});

			if (firstLoginMessage) {
				firstLoginMessage.textContent = 'Setup complete!';
				firstLoginMessage.className = 'text-sm text-emerald-600';
				firstLoginMessage.classList.remove('hidden');
			}

			// Hide modal and reload
			const modal = document.getElementById('first-login-modal');
			if (modal) {
				modal.classList.add('hidden');
			}
			setTimeout(() => window.location.reload(), 500);
		} catch (error) {
			if (firstLoginMessage) {
				firstLoginMessage.textContent = 'Failed to complete setup. Please try again.';
				firstLoginMessage.className = 'text-sm text-red-600';
				firstLoginMessage.classList.remove('hidden');
			}
		}
	});
</script>
